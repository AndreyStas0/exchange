<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ –æ–±–º—ñ–Ω—É –æ—Ä–¥–µ—Ä–∞–º–∏ (NeonDB)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* –ï–∫—Ä–∞–Ω –≤–∏–±–æ—Ä—É –∫–∞–±—ñ–Ω–µ—Ç—É */
        .cabinet-selection {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .cabinet-selection h1 {
            color: white;
            margin-bottom: 40px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .cabinet-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            max-width: 800px;
            width: 100%;
        }

        .cabinet-btn {
            background: white;
            border: none;
            padding: 30px;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .cabinet-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }

        .cabinet-btn.ua {
            color: #667eea;
        }

        .cabinet-btn.ars {
            color: #f093fb;
        }

        /* –ì–æ–ª–æ–≤–Ω–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        .main-interface {
            display: none;
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h2 {
            color: #667eea;
        }

        .logout-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .logout-btn:hover {
            background: #ff5252;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: background 0.2s ease;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #e9ecef;
            color: #495057;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: background 0.2s ease;
        }

        .btn-secondary:hover {
            background: #dee2e6;
        }

        .debt-info {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .debt-info h3 {
            margin-bottom: 10px;
            color: #667eea;
        }

        .debt-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .debt-item:last-child {
            border-bottom: none;
        }

        .debt-positive {
            color: #51cf66;
            font-weight: bold;
        }

        .debt-negative {
            color: #ff6b6b;
            font-weight: bold;
        }

        .main-content {
            display: flex;
            gap: 20px;
        }

        .sidebar {
            flex: 0 0 250px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .action-btn {
            background: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            color: #667eea;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .orders-area {
            flex: 1;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-content: flex-start;
        }

        .order-column {
            background: white;
            border-radius: 10px;
            padding: 20px;
            min-width: 350px;
            max-width: 400px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .order-column h3 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .order-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .order-card.pending {
            border-left-color: #ffd43b;
        }

        .order-card.completed {
            border-left-color: #51cf66;
            opacity: 0.7;
        }

        .order-card.cancelled {
            border-left-color: #ff6b6b;
            opacity: 0.7;
        }

        .order-detail {
            margin: 8px 0;
            font-size: 0.95em;
            word-wrap: break-word;
        }

        .order-detail strong {
            color: #495057;
        }

        .order-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .order-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .order-btn.paid {
            background: #51cf66;
            color: white;
        }

        .order-btn.paid:hover {
            background: #40c057;
        }

        .order-btn.receipt {
            background: #4dabf7;
            color: white;
        }

        .order-btn.receipt:hover {
            background: #339af0;
        }

        .order-btn.cancel {
            background: #ff6b6b;
            color: white;
        }

        .order-btn.cancel:hover {
            background: #ff5252;
        }

        .order-btn.close {
            background: #868e96;
            color: white;
            flex: 0 0 40px;
        }

        .order-btn.close:hover {
            background: #495057;
        }
        
        /* Push –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            pointer-events: none;
        }
        
        .notification {
            background: white;
            border-left: 4px solid #667eea;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 300px;
            max-width: 400px;
            pointer-events: all;
            animation: slideIn 0.3s ease-out forwards, slideOut 0.3s ease-in 2.7s forwards;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(400px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(400px);
            }
        }
        
        .notification.order {
            border-left-color: #667eea;
        }
        
        .notification.withdrawal {
            border-left-color: #f59e0b;
        }
        
        .notification.request {
            border-left-color: #10b981;
        }
        
        .notification.success {
            border-left-color: #27ae60;
            background: #f0fdf4;
        }
        
        .notification.error {
            border-left-color: #e74c3c;
            background: #fef2f2;
        }
        
        .notification-title {
            font-weight: 600;
            font-size: 1em;
            margin-bottom: 5px;
            color: #2d3748;
        }
        
        .notification-text {
            font-size: 0.9em;
            color: #4a5568;
        }
        
        /* –ê–Ω—ñ–º–∞—Ü—ñ—è –∑–º—ñ–Ω–∏ –±–∞–ª–∞–Ω—Å—É */
        .balance-change {
            animation: balanceFlash 0.6s ease-in-out;
        }
        
        @keyframes balanceFlash {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
                color: #667eea;
                font-weight: bold;
            }
        }

        .order-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: bold;
            margin-top: 10px;
        }

        .status-completed {
            background: #d3f9d8;
            color: #2b8a3e;
        }

        .status-cancelled {
            background: #ffe3e3;
            color: #c92a2a;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h3 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #495057;
        }

        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 1em;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1em;
        }

        .modal-btn.submit {
            background: #667eea;
            color: white;
        }

        .modal-btn.submit:hover {
            background: #5568d3;
        }

        .modal-btn.cancel {
            background: #868e96;
            color: white;
        }

        .modal-btn.cancel:hover {
            background: #495057;
        }

        .request-card {
            background: #fff3bf;
            border-left-color: #ffd43b;
            cursor: pointer;
        }

        .request-card:hover {
            background: #ffe066;
        }

        .file-upload {
            border: 2px dashed #dee2e6;
            padding: 20px;
            text-align: center;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .file-upload input {
            display: none;
        }

        .receipt-images {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .receipt-thumb {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid #dee2e6;
        }

        .receipt-thumb:hover {
            border-color: #667eea;
        }

        .connection-status {
            background: #d3f9d8;
            color: #2b8a3e;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .connection-status.disconnected {
            background: #ffe3e3;
            color: #c92a2a;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .sidebar {
                flex: 1;
            }

            .order-column {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è push –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- –ï–∫—Ä–∞–Ω –≤–∏–±–æ—Ä—É –∫–∞–±—ñ–Ω–µ—Ç—É -->
    <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –ø–æ –∫–ª—é—á—É -->
    <div class="cabinet-selection" id="loginScreen">
        <h1>–í—Ö—ñ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h1>
        <p style="color: #868e96; margin-bottom: 30px;">–í–≤–µ–¥—ñ—Ç—å –≤–∞—à –∫–ª—é—á –¥–æ—Å—Ç—É–ø—É</p>
        <div style="max-width: 400px; margin: 0 auto;">
            <input type="password" id="accessKeyInput" placeholder="–ö–ª—é—á –¥–æ—Å—Ç—É–ø—É (10 —Å–∏–º–≤–æ–ª—ñ–≤)" 
                   style="width: 100%; padding: 15px; font-size: 16px; border: 2px solid #dee2e6; border-radius: 8px; margin-bottom: 15px;"
                   maxlength="10">
            <button onclick="loginWithKey()" 
                    style="width: 100%; padding: 15px; font-size: 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                –£–≤—ñ–π—Ç–∏
            </button>
            <div id="loginError" style="color: #e74c3c; margin-top: 15px; display: none;"></div>
        </div>
    </div>

    <!-- –ê–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å -->
    <div class="main-interface" id="adminInterface" style="display: none;">
        <div class="header">
            <div>
                <h2>üîß –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä</h2>
                <div id="adminClock" style="color: #868e96; font-size: 0.9em; margin-top: 5px;"></div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="action-btn" onclick="openHistoryModal(true)" style="background: #48dbfb; color: #2c3e50;">üìã –Ü—Å—Ç–æ—Ä—ñ—è –æ–ø–µ—Ä–∞—Ü—ñ–π</button>
                <button onclick="logout()" class="logout-btn">–í–∏–π—Ç–∏</button>
            </div>
        </div>

        <div style="padding: 20px;">
            <h3 style="margin-bottom: 20px;">–ë–∞–ª–∞–Ω—Å–∏ –º—ñ–∂ –∫–∞–±—ñ–Ω–µ—Ç–∞–º–∏</h3>
            
            <div id="adminBalancesList" style="display: grid; gap: 15px;">
                <!-- –¢—É—Ç –±—É–¥—É—Ç—å –±–∞–ª–∞–Ω—Å–∏ -->
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –±–∞–ª–∞–Ω—Å—É -->
    <div id="editBalanceModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h3>–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –±–∞–ª–∞–Ω—Å—É</h3>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0;">
                <p id="balanceExplanation" style="margin: 0; line-height: 1.6;"></p>
            </div>

            <div class="form-group">
                <label>–ù–æ–≤–∏–π –±–∞–ª–∞–Ω—Å:</label>
                <input type="number" id="newBalanceAmount" step="0.01" placeholder="–í–≤–µ–¥—ñ—Ç—å —Å—É–º—É">
                <small style="color: #868e96; display: block; margin-top: 5px;">
                    –í—ñ–¥'—î–º–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è = –ø–µ—Ä—à–∏–π –∫–∞–±—ñ–Ω–µ—Ç –≤–∏–Ω–µ–Ω<br>
                    –î–æ–¥–∞—Ç–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è = –¥—Ä—É–≥–∏–π –∫–∞–±—ñ–Ω–µ—Ç –≤–∏–Ω–µ–Ω
                </small>
            </div>

            <div class="form-group">
                <label>–ö–æ–º–µ–Ω—Ç–∞—Ä –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</label>
                <textarea id="adminBalanceComment" rows="3" placeholder="–í–∫–∞–∂—ñ—Ç—å –ø—Ä–∏—á–∏–Ω—É –∫–æ—Ä–∏–≥—É–≤–∞–Ω–Ω—è" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #dee2e6;"></textarea>
                <small style="color: #868e96; display: block; margin-top: 5px;">–ö–æ–º–µ–Ω—Ç–∞—Ä –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–π —Ç–∞ –±—É–¥–µ –ø–æ–∫–∞–∑–∞–Ω–∏–π –≤ —ñ—Å—Ç–æ—Ä—ñ—ó –æ–ø–µ—Ä–∞—Ü—ñ–π</small>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button onclick="saveBalance()" class="btn-primary" style="flex: 1;">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                <button onclick="closeEditBalanceModal()" class="btn-secondary" style="flex: 1;">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —ñ—Å—Ç–æ—Ä—ñ—ó –æ–ø–µ—Ä–∞—Ü—ñ–π -->
    <div id="historyModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
            <h3>üìã –Ü—Å—Ç–æ—Ä—ñ—è –æ–ø–µ—Ä–∞—Ü—ñ–π</h3>
            
            <!-- –§—ñ–ª—å—Ç—Ä–∏ -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">

                    <!-- –ö–∞–±—ñ–Ω–µ—Ç (–¥–ª—è –∞–¥–º—ñ–Ω–∞) -->
                    <div id="historyCabinetFilterWrapper" style="display: none;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">–ö–∞–±—ñ–Ω–µ—Ç:</label>
                        <select id="historyCabinetFilter" onchange="filterHistory()" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #dee2e6;"></select>
                    </div>

                    <!-- –¢–∏–ø –æ–ø–µ—Ä–∞—Ü—ñ—ó -->
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">–¢–∏–ø –æ–ø–µ—Ä–∞—Ü—ñ—ó:</label>
                        <select id="historyType" onchange="filterHistory()" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #dee2e6;">
                            <option value="all">–í—Å–µ</option>
                            <option value="orders">–¢—ñ–ª—å–∫–∏ –æ—Ä–¥–µ—Ä–∏</option>
                            <option value="withdrawals">–¢—ñ–ª—å–∫–∏ –≤–∏–≤–æ–¥–∏</option>
                        </select>
                    </div>

                    <!-- –î–∞—Ç–∞ –≤—ñ–¥ -->
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">–î–∞—Ç–∞ –≤—ñ–¥:</label>
                        <input type="datetime-local" id="historyDateFrom" onchange="filterHistory()" 
                               style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #dee2e6;">
                    </div>

                    <!-- –î–∞—Ç–∞ –¥–æ -->
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">–î–∞—Ç–∞ –¥–æ:</label>
                        <input type="datetime-local" id="historyDateTo" onchange="filterHistory()" 
                               style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #dee2e6;">
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ —Å–∫–∏–Ω—É—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏ -->
                    <div style="display: flex; align-items: flex-end;">
                        <button onclick="resetHistoryFilters()" style="width: 100%; padding: 10px; background: #868e96; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            üîÑ –°–∫–∏–Ω—É—Ç–∏
                        </button>
                    </div>
                </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –æ–ø–µ—Ä–∞—Ü—ñ–π -->
            <div id="historyList" style="flex: 1; overflow-y: auto; padding-right: 10px;">
                <!-- –¢—É—Ç –±—É–¥—É—Ç—å –æ–ø–µ—Ä–∞—Ü—ñ—ó -->
            </div>

            <div style="margin-top: 20px; text-align: right;">
                <button onclick="closeHistoryModal()" class="btn-secondary">–ó–∞–∫—Ä–∏—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- –ì–æ–ª–æ–≤–Ω–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div class="main-interface" id="mainInterface">
        <div class="header">
            <div>
                <h2 id="currentCabinet"></h2>
                <div id="currentDateTime" style="font-size: 0.9em; color: #868e96; margin-top: 5px;"></div>
            </div>
            <button class="logout-btn" onclick="logout()">–í–∏–π—Ç–∏</button>
        </div>

        <div class="debt-info" id="debtInfo"></div>

        <div class="main-content">
            <div class="sidebar">
                <button class="action-btn" onclick="openRequestOrdersModal()">üì• –ó–∞–ø—Ä–æ—Å–∏—Ç–∏ –æ—Ä–¥–µ—Ä–∏</button>
                <button class="action-btn" onclick="openRequestWithdrawalModal()">üí∏ –ó–∞–ø—Ä–æ—Å–∏—Ç–∏ –≤–∏–≤—ñ–¥</button>
                <button class="action-btn" onclick="openHistoryModal()" style="background: #48dbfb; color: #2c3e50;">üìã –Ü—Å—Ç–æ—Ä—ñ—è –æ–ø–µ—Ä–∞—Ü—ñ–π</button>
            </div>

            <div class="orders-area" id="ordersArea"></div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ñ –≤—ñ–∫–Ω–∞ (–∑–∞–ª–∏—à–∏–ª–∏—Å—å —Ç–∞–∫–∏–º–∏ –∂ —è–∫ —É Firebase –≤–µ—Ä—Å—ñ—ó) -->
    <div class="modal" id="requestOrdersModal">
        <div class="modal-content">
            <h3>–ó–∞–ø—Ä–æ—Å–∏—Ç–∏ –æ—Ä–¥–µ—Ä–∏</h3>
            <div class="form-group">
                <label>–ö–∞–±—ñ–Ω–µ—Ç:</label>
                <select id="orderCabinet"></select>
            </div>
            <div class="form-group">
                <label>–°—É–º–∞ (USDT):</label>
                <input type="number" id="orderAmount" step="0.01" min="0.01">
            </div>
            <div class="form-group" id="orderTypeGroup">
                <label>–¢–∏–ø –æ—Ä–¥–µ—Ä—É:</label>
                <select id="orderType">
                    <option value="card">–ü–µ—Ä–µ–∫–∞–∑ –ø–æ –∫–∞—Ä—Ç—Ü—ñ</option>
                    <option value="iban">IBAN</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="modal-btn submit" onclick="submitOrderRequest()">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
                <button class="modal-btn cancel" onclick="closeModal('requestOrdersModal')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>

    <div class="modal" id="requestWithdrawalModal">
        <div class="modal-content">
            <h3>–ó–∞–ø—Ä–æ—Å–∏—Ç–∏ –≤–∏–≤—ñ–¥</h3>
            <div class="form-group">
                <label>–ö–∞–±—ñ–Ω–µ—Ç:</label>
                <select id="withdrawalCabinet"></select>
            </div>
            <div class="form-group">
                <label>–°—É–º–∞ (USDT):</label>
                <input type="number" id="withdrawalAmount" step="0.01" min="0.01">
            </div>
            <div class="form-group">
                <label>–ê–¥—Ä–µ—Å–∞ –≥–∞–º–∞–Ω—Ü—è:</label>
                <input type="text" id="withdrawalAddress">
            </div>
            <div class="modal-actions">
                <button class="modal-btn submit" onclick="submitWithdrawalRequest()">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
                <button class="modal-btn cancel" onclick="closeModal('requestWithdrawalModal')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>

    <div class="modal" id="addOrderDetailsModal">
        <div class="modal-content">
            <h3>–î–æ–¥–∞—Ç–∏ –¥–µ—Ç–∞–ª—ñ –æ—Ä–¥–µ—Ä—É</h3>
            <div id="orderDetailsForm"></div>
            <div class="modal-actions">
                <button class="modal-btn submit" onclick="submitOrderDetails()">–î–æ–¥–∞—Ç–∏ –æ—Ä–¥–µ—Ä</button>
                <button class="modal-btn cancel" onclick="closeModal('addOrderDetailsModal')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>

    <div class="modal" id="uploadReceiptModal">
        <div class="modal-content">
            <h3>–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–≤–∏—Ç–∞–Ω—Ü—ñ—é</h3>
            <div class="file-upload" onclick="document.getElementById('receiptInput').click()">
                <input type="file" id="receiptInput" accept="image/*" multiple onchange="handleReceiptUpload()">
                <p>üì∑ –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –≤–∏–±–æ—Ä—É —Ñ–∞–π–ª—ñ–≤</p>
                <p style="font-size: 0.9em; color: #868e96;">–ú–æ–∂–Ω–∞ –æ–±—Ä–∞—Ç–∏ –∫—ñ–ª—å–∫–∞ –∑–æ–±—Ä–∞–∂–µ–Ω—å</p>
            </div>
            <div class="receipt-images" id="receiptPreview"></div>
            <div class="modal-actions">
                <button class="modal-btn submit" onclick="submitReceipt()">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
                <button class="modal-btn cancel" onclick="closeModal('uploadReceiptModal')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>

    <div class="modal" id="viewReceiptsModal">
        <div class="modal-content">
            <h3>–ö–≤–∏—Ç–∞–Ω—Ü—ñ—ó</h3>
            <div id="receiptsDisplay"></div>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="closeModal('viewReceiptsModal')">–ó–∞–∫—Ä–∏—Ç–∏</button>
            </div>
        </div>
    </div>

    <div class="modal" id="txidModal">
        <div class="modal-content">
            <h3>–í–≤–µ–¥—ñ—Ç—å TxID</h3>
            <div class="form-group">
                <label>TxID (Transaction ID):</label>
                <input type="text" id="txidInput">
            </div>
            <div class="modal-actions">
                <button class="modal-btn submit" onclick="submitTxid()">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
                <button class="modal-btn cancel" onclick="closeModal('txidModal')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è API
        const DEFAULT_API_URL = 'http://65.108.19.238/api';
        const API_URL = window.location.origin && window.location.origin !== 'null'
            ? `${window.location.origin.replace(/\/$/, '')}/api`
            : DEFAULT_API_URL;
        let sessionId = localStorage.getItem('sessionId') || null;
        let currentCabinet = null;
        let isAdmin = false;
        let adminName = null;
        let historyViewCabinet = null;
        let isHistoryAdminView = false;
        let currentOrderId = null;
        let currentRequestId = null;
        let receiptFiles = [];
        let refreshInterval = null;
        let clockInterval = null;
        
        // –î–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –∑–º—ñ–Ω
        let previousOrders = [];
        let previousRequests = [];
        let previousWithdrawals = [];
        let previousBalances = {};

        const cabinets = [
            '–ö–∞–±—ñ–Ω–µ—Ç 1 UA', '–ö–∞–±—ñ–Ω–µ—Ç 2 UA', '–ö–∞–±—ñ–Ω–µ—Ç 3 UA', '–ö–∞–±—ñ–Ω–µ—Ç 4 UA',
            '–ö–∞–±—ñ–Ω–µ—Ç 1 ARS', '–ö–∞–±—ñ–Ω–µ—Ç 2 ARS'
        ];

        // ============================================
        // –ê–í–¢–û–†–ò–ó–ê–¶–Ü–Ø –ü–û –ö–õ–Æ–ß–£
        // ============================================

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –ø–æ –∫–ª—é—á—É
        async function loginWithKey() {
            const keyInput = document.getElementById('accessKeyInput');
            const errorDiv = document.getElementById('loginError');

            const key = keyInput.value.trim();
            
            if (!key) {
                errorDiv.textContent = '–í–≤–µ–¥—ñ—Ç—å –∫–ª—é—á –¥–æ—Å—Ç—É–ø—É';
                errorDiv.style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key: key })
                });
                
                const data = await response.json();

                if (data.success) {
                    currentCabinet = data.cabinet;
                    sessionId = data.sessionId;
                    isAdmin = data.cabinet.startsWith('ADMIN');
                    adminName = isAdmin ? data.cabinet : null;
                    historyViewCabinet = isAdmin ? 'all' : data.cabinet;

                    localStorage.setItem('cabinet', data.cabinet);
                    localStorage.setItem('sessionId', sessionId);

                    // –ó–∞–ø—É—Å–∫–∞—î–º–æ heartbeat
                    startHeartbeat();
                    
                    // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è —è–∫—â–æ IP –∑–º—ñ–Ω–∏–≤—Å—è
                    if (data.ipChanged) {
                        showNotification(
                            '‚ö†Ô∏è –£–≤–∞–≥–∞', 
                            '–í—Ö—ñ–¥ –≤–∏–∫–æ–Ω–∞–Ω–æ –∑ –Ω–æ–≤–æ–≥–æ IP –∞–¥—Ä–µ—Å–∏. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ Telegram –∫–∞–Ω–∞–ª.', 
                            'warning'
                        );
                    }
                    
                    if (isAdmin) {
                        selectAdminPanel();
                    } else {
                        selectCabinet(data.cabinet);
                    }
                } else {
                    errorDiv.textContent = data.error || '–ù–µ–≤—ñ—Ä–Ω–∏–π –∫–ª—é—á –¥–æ—Å—Ç—É–ø—É';
                    errorDiv.style.display = 'block';
                    keyInput.value = '';
                }
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = '–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞';
                errorDiv.style.display = 'block';
            }
        }

        // ============================================
        // –ê–î–ú–Ü–ù –ü–ê–ù–ï–õ–¨
        // ============================================

        let currentEditBalanceId = null;

        // –í—ñ–¥–∫—Ä–∏—Ç–∏ –∞–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å
        function selectAdminPanel() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminInterface').style.display = 'block';
            isAdmin = true;
            historyViewCabinet = 'all';

            // –ó–∞–ø—É—Å–∫ –≥–æ–¥–∏–Ω–Ω–∏–∫–∞
            updateAdminClock();
            clockInterval = setInterval(updateAdminClock, 1000);
            
            // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±–∞–ª–∞–Ω—Å—ñ–≤
            loadAdminBalances();
            
            // –ê–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–∂–Ω—ñ 10 —Å–µ–∫—É–Ω–¥
            refreshInterval = setInterval(loadAdminBalances, 10000);
        }

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≥–æ–¥–∏–Ω–Ω–∏–∫–∞ –∞–¥–º—ñ–Ω–∞
        function updateAdminClock() {
            const now = new Date();
            const options = {
                timeZone: 'Europe/Kiev',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            document.getElementById('adminClock').textContent = 
                '–ö–∏—ó–≤ (UTC+2): ' + now.toLocaleString('uk-UA', options);
        }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö –±–∞–ª–∞–Ω—Å—ñ–≤
        async function loadAdminBalances() {
            try {
                const response = await fetch(`${API_URL}/admin/balances/all`);
                const balances = await response.json();
                
                displayAdminBalances(balances);
            } catch (error) {
                console.error('Error loading balances:', error);
            }
        }

        // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –±–∞–ª–∞–Ω—Å—ñ–≤
        function displayAdminBalances(balances) {
            const container = document.getElementById('adminBalancesList');
            
            if (balances.length === 0) {
                container.innerHTML = '<p style="color: #868e96;">–ù–µ–º–∞—î –±–∞–ª–∞–Ω—Å—ñ–≤</p>';
                return;
            }

            let html = '';
            
            balances.forEach(balance => {
                const amount = parseFloat(balance.amount);
                let description = '';
                let amountColor = '#495057';
                
                if (amount < 0) {
                    // –í—ñ–¥'—î–º–Ω–∏–π –±–∞–ª–∞–Ω—Å - –ø–µ—Ä—à–∏–π –≤–∏–Ω–µ–Ω –¥—Ä—É–≥–æ–º—É
                    description = `${balance.cabinet_from} –≤–∏–Ω–µ–Ω ${balance.cabinet_to}`;
                    amountColor = '#e74c3c';
                } else if (amount > 0) {
                    // –î–æ–¥–∞—Ç–Ω–∏–π –±–∞–ª–∞–Ω—Å - –¥—Ä—É–≥–∏–π –≤–∏–Ω–µ–Ω –ø–µ—Ä—à–æ–º—É
                    description = `${balance.cabinet_to} –≤–∏–Ω–µ–Ω ${balance.cabinet_from}`;
                    amountColor = '#27ae60';
                } else {
                    // –ù—É–ª—å - —Ä—ñ–≤–Ω—ñ
                    description = `${balance.cabinet_from} ‚Üî ${balance.cabinet_to}`;
                    amountColor = '#95a5a6';
                }

                html += `
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 1.1em; margin-bottom: 5px;">
                                ${balance.cabinet_from} ‚Üî ${balance.cabinet_to}
                            </div>
                            <div style="color: #868e96; font-size: 0.9em;">
                                ${description}
                            </div>
                        </div>
                        <div style="text-align: right; display: flex; align-items: center; gap: 20px;">
                            <div style="font-size: 1.3em; font-weight: 700; color: ${amountColor};">
                                ${Math.abs(amount).toFixed(2)} USDT
                            </div>
                            <button onclick="openEditBalance(${balance.id}, '${balance.cabinet_from}', '${balance.cabinet_to}', ${amount})" 
                                    style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                ‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // –í—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
        function openEditBalance(id, cabinetFrom, cabinetTo, currentAmount) {
            currentEditBalanceId = id;
            
            // –§–æ—Ä–º—É—î–º–æ –ø–æ—è—Å–Ω–µ–Ω–Ω—è
            let explanation = '';
            if (currentAmount < 0) {
                explanation = `<strong>–ü–æ—Ç–æ—á–Ω–∏–π –±–∞–ª–∞–Ω—Å:</strong> ${currentAmount} USDT<br>`;
                explanation += `<strong>–¶–µ –æ–∑–Ω–∞—á–∞—î:</strong> ${cabinetFrom} –≤–∏–Ω–µ–Ω ${cabinetTo} ${Math.abs(currentAmount)} USDT<br><br>`;
                explanation += `<strong>–Ø–∫ –∑–º—ñ–Ω–∏—Ç–∏:</strong><br>`;
                explanation += `‚Ä¢ –í—ñ–¥'—î–º–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è ‚Üí ${cabinetFrom} –≤–∏–Ω–µ–Ω ${cabinetTo}<br>`;
                explanation += `‚Ä¢ –î–æ–¥–∞—Ç–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è ‚Üí ${cabinetTo} –≤–∏–Ω–µ–Ω ${cabinetFrom}<br>`;
                explanation += `‚Ä¢ 0 ‚Üí –±–∞–ª–∞–Ω—Å —Ä—ñ–≤–Ω–∏–π`;
            } else if (currentAmount > 0) {
                explanation = `<strong>–ü–æ—Ç–æ—á–Ω–∏–π –±–∞–ª–∞–Ω—Å:</strong> ${currentAmount} USDT<br>`;
                explanation += `<strong>–¶–µ –æ–∑–Ω–∞—á–∞—î:</strong> ${cabinetTo} –≤–∏–Ω–µ–Ω ${cabinetFrom} ${Math.abs(currentAmount)} USDT<br><br>`;
                explanation += `<strong>–Ø–∫ –∑–º—ñ–Ω–∏—Ç–∏:</strong><br>`;
                explanation += `‚Ä¢ –î–æ–¥–∞—Ç–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è ‚Üí ${cabinetTo} –≤–∏–Ω–µ–Ω ${cabinetFrom}<br>`;
                explanation += `‚Ä¢ –í—ñ–¥'—î–º–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è ‚Üí ${cabinetFrom} –≤–∏–Ω–µ–Ω ${cabinetTo}<br>`;
                explanation += `‚Ä¢ 0 ‚Üí –±–∞–ª–∞–Ω—Å —Ä—ñ–≤–Ω–∏–π`;
            } else {
                explanation = `<strong>–ü–æ—Ç–æ—á–Ω–∏–π –±–∞–ª–∞–Ω—Å:</strong> 0 USDT (—Ä—ñ–≤–Ω—ñ)<br><br>`;
                explanation += `<strong>–Ø–∫ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏:</strong><br>`;
                explanation += `‚Ä¢ –í—ñ–¥'—î–º–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è ‚Üí ${cabinetFrom} –≤–∏–Ω–µ–Ω ${cabinetTo}<br>`;
                explanation += `‚Ä¢ –î–æ–¥–∞—Ç–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è ‚Üí ${cabinetTo} –≤–∏–Ω–µ–Ω ${cabinetFrom}<br>`;
                explanation += `‚Ä¢ 0 ‚Üí –±–∞–ª–∞–Ω—Å –∑–∞–ª–∏—à–∏—Ç—å—Å—è —Ä—ñ–≤–Ω–∏–º`;
            }
            
            document.getElementById('balanceExplanation').innerHTML = explanation;
            document.getElementById('newBalanceAmount').value = currentAmount;
            document.getElementById('editBalanceModal').style.display = 'flex';
        }

        // –ó–∞–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
        function closeEditBalanceModal() {
            document.getElementById('editBalanceModal').style.display = 'none';
            currentEditBalanceId = null;
            document.getElementById('adminBalanceComment').value = '';
        }

        // –ó–±–µ—Ä–µ–≥—Ç–∏ –Ω–æ–≤–∏–π –±–∞–ª–∞–Ω—Å
        async function saveBalance() {
            const newAmount = document.getElementById('newBalanceAmount').value;
            const adminComment = document.getElementById('adminBalanceComment').value.trim();

            if (newAmount === '' || isNaN(newAmount)) {
                alert('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É —Å—É–º—É');
                return;
            }

            if (!adminComment) {
                alert('–ö–æ–º–µ–Ω—Ç–∞—Ä —î –æ–±–æ–≤\'—è–∑–∫–æ–≤–∏–º');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/admin/balances/${currentEditBalanceId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: parseFloat(newAmount),
                        admin_name: adminName,
                        comment: adminComment
                    })
                });

                const data = await response.json();

                if (data.success) {
                    closeEditBalanceModal();
                    loadAdminBalances();
                } else {
                    alert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è');
                }
            } catch (error) {
                console.error('Error saving balance:', error);
                alert('–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è');
            }
        }

        // ============================================
        // –Ü–°–¢–û–†–Ü–Ø –û–ü–ï–†–ê–¶–Ü–ô
        // ============================================

        let allHistory = [];

        function setHistoryCabinetFilterOptions() {
            const wrapper = document.getElementById('historyCabinetFilterWrapper');
            const select = document.getElementById('historyCabinetFilter');

            if (isHistoryAdminView) {
                wrapper.style.display = 'block';
                select.innerHTML = '<option value="all">–í—Å—ñ –∫–∞–±—ñ–Ω–µ—Ç–∏</option>' +
                    cabinets.map(c => `<option value="${c}">${c}</option>`).join('');
                select.value = historyViewCabinet || 'all';
            } else {
                wrapper.style.display = 'none';
            }
        }

        // –í—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —ñ—Å—Ç–æ—Ä—ñ—ó
        async function openHistoryModal(forAdmin = false) {
            isHistoryAdminView = forAdmin && isAdmin;
            historyViewCabinet = isHistoryAdminView ? 'all' : currentCabinet;
            setHistoryCabinetFilterOptions();

            document.getElementById('historyModal').style.display = 'flex';
            document.getElementById('historyList').innerHTML =
                '<p style="text-align: center; color: #868e96; padding: 40px;">‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>';
            resetHistoryFilters();
            await loadHistory();
        }

        // –ó–∞–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —ñ—Å—Ç–æ—Ä—ñ—ó
        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }

        function operationHasCabinet(item, cabinet) {
            if (!cabinet || cabinet === 'all') return true;

            if (item.operation_type === 'order' || item.operation_type === 'withdrawal') {
                return item.from_cabinet === cabinet || item.to_cabinet === cabinet;
            }

            if (item.operation_type === 'balance_adjustment') {
                return item.cabinet_from === cabinet || item.cabinet_to === cabinet;
            }

            return false;
        }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é
        async function loadHistory() {
            try {
                const cabinetParam = isHistoryAdminView && historyViewCabinet && historyViewCabinet !== 'all'
                    ? `?cabinet=${encodeURIComponent(historyViewCabinet)}`
                    : '';
                const endpoint = isHistoryAdminView
                    ? `${API_URL}/admin/history${cabinetParam}`
                    : `${API_URL}/history/${currentCabinet}`;

                const response = await fetch(endpoint);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                allHistory = await response.json();

                if (allHistory.length === 0) {
                    document.getElementById('historyList').innerHTML =
                        '<p style="text-align: center; color: #868e96; padding: 40px;">üì≠ –ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –∑–∞–≤–µ—Ä—à–µ–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π.<br><br>–Ü—Å—Ç–æ—Ä—ñ—è –±—É–¥–µ –¥–æ—Å—Ç—É–ø–Ω–∞ –ø—ñ—Å–ª—è –æ–ø–ª–∞—Ç–∏ –æ—Ä–¥–µ—Ä—ñ–≤ –∞–±–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤–∏–≤–æ–¥—ñ–≤.</p>';
                } else {
                    filterHistory();
                }
            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('historyList').innerHTML =
                    `<p style="text-align: center; color: #e74c3c; padding: 40px;">
                        ‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó<br><br>
                        <small>${error.message}</small><br><br>
                        <button onclick="loadHistory()" class="btn-primary">–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑</button>
                    </p>`;
            }
        }

        // –§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é
        function filterHistory() {
            const type = document.getElementById('historyType').value;
            const dateFrom = document.getElementById('historyDateFrom').value;
            const dateTo = document.getElementById('historyDateTo').value;
            const selectedCabinet = isHistoryAdminView
                ? document.getElementById('historyCabinetFilter').value
                : historyViewCabinet;

            historyViewCabinet = selectedCabinet;

            let filtered = [...allHistory];

            if (isHistoryAdminView && selectedCabinet && selectedCabinet !== 'all') {
                filtered = filtered.filter(item => operationHasCabinet(item, selectedCabinet));
            }

            // –§—ñ–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É
            if (type === 'orders') {
                filtered = filtered.filter(item => item.operation_type === 'order');
            } else if (type === 'withdrawals') {
                filtered = filtered.filter(item => item.operation_type === 'withdrawal');
            }

            // –§—ñ–ª—å—Ç—Ä –ø–æ –¥–∞—Ç—ñ –≤—ñ–¥
            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                filtered = filtered.filter(item => new Date(item.created_at) >= fromDate);
            }

            // –§—ñ–ª—å—Ç—Ä –ø–æ –¥–∞—Ç—ñ –¥–æ
            if (dateTo) {
                const toDate = new Date(dateTo);
                filtered = filtered.filter(item => new Date(item.created_at) <= toDate);
            }

            displayHistory(filtered);
        }

        
        // –í—ñ–¥–æ–±—Ä–∞–∑–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é
        function displayHistory(history) {
            const container = document.getElementById('historyList');

            if (history.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #868e96; padding: 40px;">–ù–µ–º–∞—î –æ–ø–µ—Ä–∞—Ü—ñ–π –∑–∞ –æ–±—Ä–∞–Ω–∏–º–∏ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏</p>';
                return;
            }

            let html = '<div style="display: grid; gap: 15px;">';
            const contextCabinet = historyViewCabinet && historyViewCabinet !== 'all' ? historyViewCabinet : null;

            history.forEach(item => {
                const date = new Date(item.created_at);
                const dateStr = date.toLocaleDateString('uk-UA', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                const timeStr = date.toLocaleTimeString('uk-UA', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                if (item.operation_type === 'order') {
                    const isIncoming = contextCabinet ? item.to_cabinet === contextCabinet : false;
                    const otherCabinet = contextCabinet
                        ? (isIncoming ? item.from_cabinet : item.to_cabinet)
                        : `${item.from_cabinet} ‚Üí ${item.to_cabinet}`;
                    let direction = 'üîÑ –û—Ä–¥–µ—Ä';
                    let directionColor = '#8e44ad';

                    if (contextCabinet) {
                        direction = isIncoming ? 'üì• –í—Ö—ñ–¥–Ω–∏–π' : 'üì§ –í–∏—Ö—ñ–¥–Ω–∏–π';
                        directionColor = isIncoming ? '#27ae60' : '#3498db';
                    }

                    let receiptsHtml = '';
                    if (item.receipt_files) {
                        try {
                            let receipts = [];

                            if (typeof item.receipt_files === 'string') {
                                if (item.receipt_files.startsWith('[')) {
                                    receipts = JSON.parse(item.receipt_files);
                                } else if (item.receipt_files.startsWith('data:image')) {
                                    receipts = [item.receipt_files];
                                } else if (item.receipt_files.startsWith('/uploads')) {
                                    receipts = [item.receipt_files];
                                }
                            } else if (Array.isArray(item.receipt_files)) {
                                receipts = item.receipt_files;
                            }

                            if (receipts.length > 0) {
                                receiptsHtml = `
                                    <div style="margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 6px;">
                                        <div style="font-weight: 600; margin-bottom: 8px; color: #27ae60;">üìé –ö–≤–∏—Ç–∞–Ω—Ü—ñ—ó (${receipts.length}):</div>
                                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                            ${receipts.map((receipt, idx) => `
                                                <a href="${receipt}" target="_blank"
                                                   style="display: inline-block; padding: 6px 12px; background: white;
                                                          border: 1px solid #27ae60; border-radius: 6px;
                                                          color: #27ae60; text-decoration: none; font-size: 0.85em;
                                                          transition: all 0.2s;">
                                                    üñºÔ∏è –ö–≤–∏—Ç–∞–Ω—Ü—ñ—è ${idx + 1}
                                                </a>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            }
                        } catch (e) {
                            console.error('Error parsing receipts:', e, 'Data:', item.receipt_files);
                        }
                    }

                    html += `
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid ${directionColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <div style="font-weight: 700; font-size: 1.1em; color: ${directionColor};">
                                        ${direction} –æ—Ä–¥–µ—Ä #${item.id}
                                    </div>
                                    <div style="color: #868e96; font-size: 0.9em; margin-top: 5px;">
                                        –°—Ç–≤–æ—Ä–µ–Ω–æ: ${dateStr} –æ ${timeStr}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.4em; font-weight: 700; color: #2c3e50;">
                                        ${item.amount} USDT
                                    </div>
                                    <div style="color: #868e96; font-size: 0.85em; margin-top: 5px;">
                                        ${item.order_type === 'card' ? 'üí≥ –ö–∞—Ä—Ç–∫–∞' : 'üè¶ IBAN'}
                                    </div>
                                </div>
                            </div>

                            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-top: 10px;">
                                <div style="color: #495057; font-size: 0.95em; margin-bottom: 8px;">
                                    ${contextCabinet ? `<strong>${isIncoming ? '–í—ñ–¥:' : '–î–æ:'}</strong> ${otherCabinet}` : `–ö–∞–±—ñ–Ω–µ—Ç–∏: <strong>${item.from_cabinet}</strong> ‚Üí <strong>${item.to_cabinet}</strong>`}
                                </div>

                                ${item.amount_local ? `
                                    <div style="color: #495057; font-size: 0.9em; margin-bottom: 5px;">
                                        üíµ –°—É–º–∞: <strong>${item.amount_local} ${item.order_type === 'card' || item.order_type === 'iban' ? 'UAH' : 'ARS'}</strong>
                                    </div>
                                ` : ''}

                                ${item.card_number ? `
                                    <div style="color: #495057; font-size: 0.9em; margin-bottom: 5px;">
                                        üí≥ –ö–∞—Ä—Ç–∫–∞: <code>${item.card_number}</code>
                                    </div>
                                ` : ''}

                                ${item.iban ? `
                                    <div style="color: #495057; font-size: 0.9em; margin-bottom: 5px;">
                                        üè¶ IBAN: <code>${item.iban}</code>
                                    </div>
                                ` : ''}

                                ${item.tax_number ? `
                                    <div style="color: #495057; font-size: 0.9em; margin-bottom: 5px;">
                                        üÜî Tax Number: <code>${item.tax_number}</code>
                                    </div>
                                ` : ''}

                                ${item.cvu ? `
                                    <div style="color: #495057; font-size: 0.9em; margin-bottom: 5px;">
                                        üî¢ CVU: <code>${item.cvu}</code>
                                    </div>
                                ` : ''}

                                ${item.fio ? `
                                    <div style="color: #495057; font-size: 0.9em; margin-bottom: 5px;">
                                        üë§ –ü–Ü–ë: <strong>${item.fio}</strong>
                                    </div>
                                ` : ''}

                                ${item.comment ? `
                                    <div style="color: #495057; font-size: 0.9em; margin-top: 8px; padding-top: 8px; border-top: 1px solid #dee2e6;">
                                        üí¨ –ö–æ–º–µ–Ω—Ç–∞—Ä: <em>${item.comment}</em>
                                    </div>
                                ` : ''}
                            </div>

                            ${receiptsHtml}
                        </div>
                    `;
                } else if (item.operation_type === 'withdrawal') {
                    const isRequested = contextCabinet ? item.from_cabinet === contextCabinet : false;
                    const otherCabinet = contextCabinet
                        ? (isRequested ? item.to_cabinet : item.from_cabinet)
                        : `${item.from_cabinet} ‚Üí ${item.to_cabinet}`;
                    const direction = contextCabinet
                        ? (isRequested ? 'üí∏ –ó–∞–ø—Ä–æ—à–µ–Ω–∏–π –≤–∏–≤—ñ–¥' : '‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–∏–π –≤–∏–≤—ñ–¥')
                        : 'üí∏ –í–∏–≤—ñ–¥';
                    const directionColor = contextCabinet
                        ? (isRequested ? '#e67e22' : '#27ae60')
                        : '#16a085';

                    html += `
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid ${directionColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <div style="font-weight: 700; font-size: 1.1em; color: ${directionColor};">
                                        ${direction}
                                    </div>
                                    <div style="color: #868e96; font-size: 0.9em; margin-top: 5px;">
                                        ${dateStr} –æ ${timeStr}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.4em; font-weight: 700; color: #2c3e50;">
                                        ${item.amount} USDT
                                    </div>
                                </div>
                            </div>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-top: 10px;">
                                <div style="color: #495057; font-size: 0.95em; margin-bottom: 5px;">
                                    ${contextCabinet
                                        ? (isRequested ? `–ß–µ—Ä–µ–∑: <strong>${otherCabinet}</strong>` : `–í—ñ–¥: <strong>${otherCabinet}</strong>`)
                                        : `–ö–∞–±—ñ–Ω–µ—Ç–∏: <strong>${item.from_cabinet}</strong> ‚Üí <strong>${item.to_cabinet}</strong>`}
                                </div>
                                ${item.txid ? `<div style="color: #495057; font-size: 0.85em; word-break: break-all;">TxID: <code style="background: #e9ecef; padding: 2px 6px; border-radius: 3px; font-size: 0.9em;">${item.txid}</code></div>` : ''}
                            </div>
                        </div>
                    `;
                } else if (item.operation_type === 'balance_adjustment') {
                    const delta = parseFloat(item.amount_new) - parseFloat(item.amount_old);
                    const deltaColor = delta >= 0 ? '#27ae60' : '#e74c3c';

                    html += `
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #34495e;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <div style="font-weight: 700; font-size: 1.1em; color: #34495e;">
                                        ‚öñÔ∏è –ö–æ—Ä–µ–∫—Ü—ñ—è –±–∞–ª–∞–Ω—Å—É
                                    </div>
                                    <div style="color: #868e96; font-size: 0.9em; margin-top: 5px;">
                                        ${dateStr} –æ ${timeStr}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 600; color: #2c3e50;">${item.cabinet_from} ‚Üî ${item.cabinet_to}</div>
                                    <div style="font-size: 1.1em; font-weight: 700; color: ${deltaColor}; margin-top: 4px;">
                                        ${delta >= 0 ? '+' : '-'}${Math.abs(delta).toFixed(2)} USDT
                                    </div>
                                </div>
                            </div>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-top: 10px;">
                                <div style="color: #495057; font-size: 0.95em; margin-bottom: 6px;">
                                    üëÆ‚Äç‚ôÇÔ∏è –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä: <strong>${item.admin_name}</strong>
                                </div>
                                <div style="color: #495057; font-size: 0.9em;">–ë—É–ª–æ: <strong>${parseFloat(item.amount_old).toFixed(2)} USDT</strong></div>
                                <div style="color: #495057; font-size: 0.9em;">–°—Ç–∞–ª–æ: <strong>${parseFloat(item.amount_new).toFixed(2)} USDT</strong></div>
                                ${item.comment ? `<div style="color: #495057; font-size: 0.9em; margin-top: 8px; padding-top: 8px; border-top: 1px solid #dee2e6;">üí¨ –ö–æ–º–µ–Ω—Ç–∞—Ä: <em>${item.comment}</em></div>` : ''}
                            </div>
                        </div>
                    `;
                }
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // –°–∫–∏–Ω—É—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏
        function resetHistoryFilters() {
            document.getElementById('historyType').value = 'all';
            document.getElementById('historyDateFrom').value = '';
            document.getElementById('historyDateTo').value = '';
            filterHistory();
        }

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        window.addEventListener('load', async () => {
            const savedKey = localStorage.getItem('accessKey');
            const savedCabinet = localStorage.getItem('cabinet');

            if (savedKey && savedCabinet) {
                try {
                    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –∫–ª—é—á –≤—Å–µ —â–µ –≤–∞–ª—ñ–¥–Ω–∏–π
                    const response = await fetch(`${API_URL}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ key: savedKey })
                    });

                    const data = await response.json();

                    if (data.success && data.cabinet === savedCabinet) {
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –≤—Ö—ñ–¥
                        isAdmin = savedCabinet.startsWith('ADMIN');
                        adminName = isAdmin ? savedCabinet : null;
                        historyViewCabinet = isAdmin ? 'all' : savedCabinet;

                        if (isAdmin) {
                            selectAdminPanel();
                        } else {
                            selectCabinet(savedCabinet);
                        }
                    } else {
                        // –ö–ª—é—á –±—ñ–ª—å—à–µ –Ω–µ –≤–∞–ª—ñ–¥–Ω–∏–π - –æ—á–∏—â–∞—î–º–æ
                        localStorage.removeItem('accessKey');
                        localStorage.removeItem('cabinet');
                    }
                } catch (error) {
                    console.error('Auto-login error:', error);
                }
            }
        });

        // Enter –¥–ª—è –≤—Ö–æ–¥—É
        document.addEventListener('DOMContentLoaded', () => {
            const keyInput = document.getElementById('accessKeyInput');
            if (keyInput) {
                keyInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        loginWithKey();
                    }
                });
            }
        });

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞—Ç–∏/—á–∞—Å—É –≤ UTC+2
        function getUTC2DateTime() {
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const utc2 = new Date(utc + (3600000 * 2));
            return utc2;
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –¥–∞—Ç–∏/—á–∞—Å—É
        function formatDateTime(date) {
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            const hours = String(d.getHours()).padStart(2, '0');
            const minutes = String(d.getMinutes()).padStart(2, '0');
            const seconds = String(d.getSeconds()).padStart(2, '0');
            return `${day}.${month}.${year} ${hours}:${minutes}:${seconds}`;
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –∫–æ—Ä–æ—Ç–∫–æ—ó –¥–∞—Ç–∏/—á–∞—Å—É (–¥–ª—è –∫–∞—Ä—Ç–æ–∫)
        function formatShortDateTime(dateString) {
            if (!dateString) return '';
            const utc = new Date(dateString);
            const utc2 = new Date(utc.getTime() + (3600000 * 2));
            const day = String(utc2.getDate()).padStart(2, '0');
            const month = String(utc2.getMonth() + 1).padStart(2, '0');
            const hours = String(utc2.getHours()).padStart(2, '0');
            const minutes = String(utc2.getMinutes()).padStart(2, '0');
            return `${day}.${month} ${hours}:${minutes}`;
        }

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≥–æ–¥–∏–Ω–Ω–∏–∫–∞
        function updateClock() {
            const utc2Time = getUTC2DateTime();
            document.getElementById('currentDateTime').textContent = 
                formatDateTime(utc2Time) + ' (UTC+2)';
        }

        // –ü–æ–∫–∞–∑ push –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        function showNotification(title, text, type = 'order') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-title">${title}</div>
                <div class="notification-text">${text}</div>
            `;
            container.appendChild(notification);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥–∏
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ============================================
        // –§–£–ù–ö–¶–Ü–Ø –ö–û–ü–Ü–Æ–í–ê–ù–ù–Ø
        // ============================================

        function copyToClipboard(text, buttonElement) {
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –¥–æ—Å—Ç—É–ø–Ω–∏–π navigator.clipboard (–ø—Ä–∞—Ü—é—î —Ç—ñ–ª—å–∫–∏ –Ω–∞ HTTPS –∞–±–æ localhost)
            if (navigator.clipboard && navigator.clipboard.writeText) {
                // –°—É—á–∞—Å–Ω–∏–π API –¥–ª—è HTTPS
                navigator.clipboard.writeText(text).then(() => {
                    showNotification('‚úÖ –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ', text, 'success');
                    
                    const originalBg = buttonElement.style.background;
                    buttonElement.style.background = '#27ae60';
                    
                    setTimeout(() => {
                        buttonElement.style.background = originalBg;
                    }, 1000);
                }).catch(err => {
                    console.error('Error copying:', err);
                    showNotification('‚ùå –ü–æ–º–∏–ª–∫–∞', '–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏', 'error');
                });
            } else {
                // Fallback –¥–ª—è HTTP (—Å—Ç–∞—Ä–∏–π –º–µ—Ç–æ–¥)
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                
                try {
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textarea);
                    
                    if (successful) {
                        showNotification('‚úÖ –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ', text, 'success');
                        
                        const originalBg = buttonElement.style.background;
                        buttonElement.style.background = '#27ae60';
                        
                        setTimeout(() => {
                            buttonElement.style.background = originalBg;
                        }, 1000);
                    } else {
                        showNotification('‚ùå –ü–æ–º–∏–ª–∫–∞', '–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏', 'error');
                    }
                } catch (err) {
                    document.body.removeChild(textarea);
                    console.error('Fallback copy error:', err);
                    showNotification('‚ùå –ü–æ–º–∏–ª–∫–∞', '–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏', 'error');
                }
            }
        }

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–æ–≤–∏—Ö –æ—Ä–¥–µ—Ä—ñ–≤
        function checkNewOrders(orders) {
            const currentIds = orders.map(o => o.id);
            const previousIds = previousOrders.map(o => o.id);
            
            // –ù–æ–≤—ñ –æ—Ä–¥–µ—Ä–∏ (—Ç—ñ–ª—å–∫–∏ –≤—Ö—ñ–¥–Ω—ñ)
            const newOrders = orders.filter(o => 
                !previousIds.includes(o.id) && o.to_cabinet === currentCabinet
            );
            
            console.log('Checking orders:', { currentIds, previousIds, newOrders });
            
            newOrders.forEach(order => {
                console.log('New order for us!', order);
                showNotification(
                    'üì• –ù–æ–≤–∏–π –æ—Ä–¥–µ—Ä',
                    `–í—ñ–¥ ${order.from_cabinet}: ${order.amount_usdt} USDT`,
                    'order'
                );
            });
            
            // –û–ø–ª–∞—á–µ–Ω—ñ –æ—Ä–¥–µ—Ä–∏ (—è–∫—ñ –º–∏ –≤—ñ–¥–ø—Ä–∞–≤–∏–ª–∏)
            const paidOrders = orders.filter(o => {
                const prev = previousOrders.find(p => p.id === o.id);
                return prev && prev.status === 'pending' && o.status === 'completed' 
                       && o.from_cabinet === currentCabinet;
            });
            
            paidOrders.forEach(order => {
                console.log('Our order was paid!', order);
                showNotification(
                    '‚úÖ –û—Ä–¥–µ—Ä –æ–ø–ª–∞—á–µ–Ω–æ',
                    `${order.to_cabinet} –æ–ø–ª–∞—Ç–∏–≤ ${order.amount_usdt} USDT`,
                    'order'
                );
            });
            
            // –í—ñ–¥–º—ñ–Ω–µ–Ω—ñ –æ—Ä–¥–µ—Ä–∏ (—è–∫—ñ –º–∏ –≤—ñ–¥–ø—Ä–∞–≤–∏–ª–∏)
            const cancelledOrders = orders.filter(o => {
                const prev = previousOrders.find(p => p.id === o.id);
                return prev && prev.status === 'pending' && o.status === 'cancelled' 
                       && o.from_cabinet === currentCabinet;
            });
            
            cancelledOrders.forEach(order => {
                console.log('Our order was cancelled!', order);
                showNotification(
                    '‚ö†Ô∏è –û—Ä–¥–µ—Ä –≤—ñ–¥–º—ñ–Ω–µ–Ω–æ',
                    `${order.to_cabinet} –≤—ñ–¥–º—ñ–Ω–∏–≤ –æ—Ä–¥–µ—Ä ${order.amount_usdt} USDT`,
                    'withdrawal'
                );
            });
            
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –∫–æ–ø—ñ—é –º–∞—Å–∏–≤—É
            previousOrders = [...orders];
        }

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–æ–≤–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤
        function checkNewRequests(requests) {
            const currentIds = requests.map(r => r.id);
            const previousIds = previousRequests.map(r => r.id);
            
            // –ù–æ–≤—ñ –∑–∞–ø–∏—Ç–∏ (—Ç—ñ–ª—å–∫–∏ –≤—Ö—ñ–¥–Ω—ñ)
            const newRequests = requests.filter(r => 
                !previousIds.includes(r.id) && r.to_cabinet === currentCabinet
            );
            
            console.log('Checking requests:', { currentIds, previousIds, newRequests });
            
            newRequests.forEach(request => {
                console.log('New request for us!', request);
                showNotification(
                    'üìã –ù–æ–≤–∏–π –∑–∞–ø–∏—Ç –Ω–∞ –æ—Ä–¥–µ—Ä–∏',
                    `–í—ñ–¥ ${request.from_cabinet}: ${request.amount} USDT`,
                    'request'
                );
            });
            
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –∫–æ–ø—ñ—é –º–∞—Å–∏–≤—É
            previousRequests = [...requests];
        }

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–æ–≤–∏—Ö –≤–∏–≤–æ–¥—ñ–≤
        function checkNewWithdrawals(withdrawals) {
            const currentIds = withdrawals.map(w => w.id);
            const previousIds = previousWithdrawals.map(w => w.id);
            
            // –ù–æ–≤—ñ –∑–∞–ø–∏—Ç–∏ –Ω–∞ –≤–∏–≤—ñ–¥ (—Ç—ñ–ª—å–∫–∏ –≤—Ö—ñ–¥–Ω—ñ)
            const newWithdrawals = withdrawals.filter(w => 
                !previousIds.includes(w.id) && w.to_cabinet === currentCabinet
            );
            
            console.log('Checking withdrawals:', { currentIds, previousIds, newWithdrawals });
            
            newWithdrawals.forEach(withdrawal => {
                console.log('New withdrawal for us!', withdrawal);
                showNotification(
                    'üí∏ –ù–æ–≤–∏–π –∑–∞–ø–∏—Ç –Ω–∞ –≤–∏–≤—ñ–¥',
                    `–í—ñ–¥ ${withdrawal.from_cabinet}: ${withdrawal.amount} USDT`,
                    'withdrawal'
                );
            });
            
            // –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω—ñ –≤–∏–≤–æ–¥–∏ (—è–∫—ñ –º–∏ –∑–∞–ø—Ä–æ—Å–∏–ª–∏)
            const completedWithdrawals = withdrawals.filter(w => {
                const prev = previousWithdrawals.find(p => p.id === w.id);
                return prev && prev.status === 'pending' && w.status === 'completed' 
                       && w.from_cabinet === currentCabinet;
            });
            
            completedWithdrawals.forEach(withdrawal => {
                console.log('Our withdrawal was completed!', withdrawal);
                const shortTxid = withdrawal.txid.length > 10 
                    ? withdrawal.txid.substring(0, 10) + '...' 
                    : withdrawal.txid;
                showNotification(
                    '‚úÖ –í–∏–≤—ñ–¥ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ',
                    `${withdrawal.amount} USDT. TxID: ${shortTxid}`,
                    'order'
                );
            });
            
            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –∫–æ–ø—ñ—é –º–∞—Å–∏–≤—É
            previousWithdrawals = [...withdrawals];
        }

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–º—ñ–Ω–∏ –±–∞–ª–∞–Ω—Å—ñ–≤
        function checkBalanceChanges(balances) {
            console.log('Checking balances:', { old: previousBalances, new: balances });
            
            Object.keys(balances).forEach(cabinet => {
                const oldBalance = previousBalances[cabinet] || 0;
                const newBalance = balances[cabinet] || 0;
                
                if (oldBalance !== newBalance) {
                    console.log('Balance changed for', cabinet, 'from', oldBalance, 'to', newBalance);
                    
                    // –î–æ–¥–∞—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—é –¥–æ –µ–ª–µ–º–µ–Ω—Ç—É –±–∞–ª–∞–Ω—Å—É
                    const debtItems = document.querySelectorAll('.debt-item');
                    debtItems.forEach(item => {
                        if (item.textContent.includes(cabinet)) {
                            const balanceSpan = item.querySelector('span:last-child');
                            if (balanceSpan) {
                                console.log('Adding animation to', cabinet);
                                balanceSpan.classList.add('balance-change');
                                setTimeout(() => {
                                    balanceSpan.classList.remove('balance-change');
                                }, 600);
                            }
                        }
                    });
                }
            });
            
            previousBalances = { ...balances };
        }

        // –í–∏–±—ñ—Ä –∫–∞–±—ñ–Ω–µ—Ç—É
        function selectCabinet(cabinet) {
            currentCabinet = cabinet;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainInterface').style.display = 'block';
            document.getElementById('currentCabinet').textContent = cabinet;
            
            populateCabinetSelects();
            updateInterface();
            
            // –ó–∞–ø—É—Å–∫ –≥–æ–¥–∏–Ω–Ω–∏–∫–∞
            updateClock();
            clockInterval = setInterval(updateClock, 1000);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–∂–Ω—ñ 3 —Å–µ–∫—É–Ω–¥–∏
            refreshInterval = setInterval(updateInterface, 3000);
        }

        // –í–∏—Ö—ñ–¥
        // Heartbeat –¥–ª—è –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ —Å–µ—Å—ñ—ó
        let heartbeatInterval = null;
        
        function startHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
            }
            
            heartbeatInterval = setInterval(async () => {
                if (!sessionId) return;
                
                try {
                    const response = await fetch(`${API_URL}/auth/heartbeat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sessionId: sessionId })
                    });
                    
                    const data = await response.json();
                    
                    if (!data.valid) {
                        // –°–µ—Å—ñ—è –Ω–µ–≤–∞–ª—ñ–¥–Ω–∞ - –≤–∏—Ö–æ–¥–∏–º–æ
                        showNotification(
                            'üö´ –°–µ—Å—ñ—è –∑–∞–∫—ñ–Ω—á–µ–Ω–∞',
                            '–í–∞—à–∞ —Å–µ—Å—ñ—è –±—É–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.',
                            'error'
                        );
                        setTimeout(() => logout(), 2000);
                    }
                } catch (error) {
                    console.error('Heartbeat error:', error);
                }
            }, 30000); // –ö–æ–∂–Ω—ñ 30 —Å–µ–∫—É–Ω–¥
        }
        
        function logout() {
            if (sessionId) {
                fetch(`${API_URL}/auth/logout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: sessionId })
                }).catch(err => console.error('Logout error:', err));
            }
            
            localStorage.removeItem('cabinet');
            localStorage.removeItem('sessionId');
            sessionId = null;
            currentCabinet = null;
            adminName = null;
            isAdmin = false;
            historyViewCabinet = null;

            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
            }
            
            window.location.reload();
        }

        // –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –≤–∏–ø–∞–¥–∞—é—á–∏—Ö —Å–ø–∏—Å–∫—ñ–≤
        function populateCabinetSelects() {
            const selects = ['orderCabinet', 'withdrawalCabinet'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '';
                cabinets.forEach(cab => {
                    if (cab !== currentCabinet) {
                        const option = document.createElement('option');
                        option.value = cab;
                        option.textContent = cab;
                        select.appendChild(option);
                    }
                });
            });

            updateOrderTypeOptions();
        }

        function updateOrderTypeOptions() {
            const orderCabinet = document.getElementById('orderCabinet').value;

            // –Ø–∫—â–æ –ø–æ—Ç–æ—á–Ω–∏–π –∫–∞–±—ñ–Ω–µ—Ç ARS —ñ –∑–∞–ø–∏—Ç—É—î —É UA - —Ç—ñ–ª—å–∫–∏ CVU
            if (currentCabinet.includes('ARS') && orderCabinet.includes('UA')) {
                const orderType = document.getElementById('orderType');
                orderType.innerHTML = '<option value="cvu">CVU</option>';
            }
            // –Ø–∫—â–æ –∑–∞–ø–∏—Ç—É—î–º–æ —É ARS –∫–∞–±—ñ–Ω–µ—Ç—É - —Ç—ñ–ª—å–∫–∏ CVU
            else if (orderCabinet.includes('ARS')) {
                const orderType = document.getElementById('orderType');
                orderType.innerHTML = '<option value="cvu">CVU</option>';
            }
            // –í —ñ–Ω—à–∏—Ö –≤–∏–ø–∞–¥–∫–∞—Ö - –∫–∞—Ä—Ç–∫–∞ –∞–±–æ IBAN
            else {
                const orderType = document.getElementById('orderType');
                orderType.innerHTML = `
                    <option value="card">–ü–µ—Ä–µ–∫–∞–∑ –ø–æ –∫–∞—Ä—Ç—Ü—ñ</option>
                    <option value="iban">IBAN</option>
                `;
            }
        }

        document.getElementById('orderCabinet')?.addEventListener('change', updateOrderTypeOptions);

        function openRequestOrdersModal() {
            document.getElementById('requestOrdersModal').style.display = 'flex';
        }

        function openRequestWithdrawalModal() {
            document.getElementById('requestWithdrawalModal').style.display = 'flex';
        }



        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'uploadReceiptModal') {
                receiptFiles = [];
                document.getElementById('receiptPreview').innerHTML = '';
            }
        }

        // –ó–∞–ø–∏—Ç –Ω–∞ –æ—Ä–¥–µ—Ä–∏
        async function submitOrderRequest() {
            const cabinet = document.getElementById('orderCabinet').value;
            const amount = parseFloat(document.getElementById('orderAmount').value);
            const type = document.getElementById('orderType').value;

            if (!amount || amount <= 0) {
                alert('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É —Å—É–º—É');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/order-requests`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        from_cabinet: currentCabinet,
                        to_cabinet: cabinet,
                        amount: amount,
                        type: type
                    })
                });

                if (response.ok) {
                    closeModal('requestOrdersModal');
                    document.getElementById('orderAmount').value = '';
                    updateInterface();
                } else {
                    alert('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–ø–∏—Ç—É');
                }
            } catch (error) {
                console.error(error);
                
            }
        }

        // –í—ñ–¥–º—ñ–Ω–∞ –∑–∞–ø–∏—Ç—É –Ω–∞ –æ—Ä–¥–µ—Ä–∏
        async function cancelOrderRequest(requestId) {
            if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤—ñ–¥–º—ñ–Ω–∏—Ç–∏ —Ü–µ–π –∑–∞–ø–∏—Ç?')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/order-requests/${requestId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    updateInterface();
                } else {
                    alert('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–º—ñ–Ω–∏ –∑–∞–ø–∏—Ç—É');
                }
            } catch (error) {
                console.error(error);
            }
        }

        // –ó–∞–ø–∏—Ç –Ω–∞ –≤–∏–≤—ñ–¥
        async function submitWithdrawalRequest() {
            const cabinet = document.getElementById('withdrawalCabinet').value;
            const amount = parseFloat(document.getElementById('withdrawalAmount').value);
            const address = document.getElementById('withdrawalAddress').value;

            if (!amount || amount <= 0) {
                alert('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É —Å—É–º—É');
                return;
            }

            if (!address) {
                alert('–í–≤–µ–¥—ñ—Ç—å –∞–¥—Ä–µ—Å—É –≥–∞–º–∞–Ω—Ü—è');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/withdrawals`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        from_cabinet: currentCabinet,
                        to_cabinet: cabinet,
                        amount: amount,
                        address: address
                    })
                });

                if (response.ok) {
                    closeModal('requestWithdrawalModal');
                    document.getElementById('withdrawalAmount').value = '';
                    document.getElementById('withdrawalAddress').value = '';
                    updateInterface();
                } else {
                    const data = await response.json();
                    alert(data.error || '–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–ø–∏—Ç—É');
                }
            } catch (error) {
                console.error(error);
                
            }
        }

        // –î–æ–¥–∞–≤–∞–Ω–Ω—è –¥–µ—Ç–∞–ª–µ–π –æ—Ä–¥–µ—Ä—É
        function openAddOrderDetails(requestId) {
            currentRequestId = requestId;
            
            fetch(`${API_URL}/order-requests`)
                .then(res => res.json())
                .then(requests => {
                    const request = requests.find(r => r.id == requestId);
                    if (!request) return;

                    let formHtml = '';

                    if (request.type === 'card') {
                        formHtml = `
                            <div class="form-group">
                                <label>–ù–æ–º–µ—Ä –∫–∞—Ä—Ç–∫–∏:</label>
                                <input type="text" id="cardNumber">
                            </div>
                            <div class="form-group">
                                <label>–°—É–º–∞ (UAH):</label>
                                <input type="number" id="amountLocal" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>–°—É–º–∞ (USDT):</label>
                                <input type="number" id="amountUSDT" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>–ü—Ä–∏–º—ñ—Ç–∫–∞:</label>
                                <textarea id="note" rows="3"></textarea>
                            </div>
                        `;
                    } else if (request.type === 'iban') {
                        formHtml = `
                            <div class="form-group">
                                <label>IBAN:</label>
                                <input type="text" id="iban">
                            </div>
                            <div class="form-group">
                                <label>–ü–æ–¥–∞—Ç–∫–æ–≤–∏–π –Ω–æ–º–µ—Ä:</label>
                                <input type="text" id="taxNumber">
                            </div>
                            <div class="form-group">
                                <label>–ü–Ü–ë:</label>
                                <input type="text" id="fullName">
                            </div>
                            <div class="form-group">
                                <label>–°—É–º–∞ (UAH):</label>
                                <input type="number" id="amountLocal" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>–°—É–º–∞ (USDT):</label>
                                <input type="number" id="amountUSDT" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>–ü—Ä–∏–º—ñ—Ç–∫–∞:</label>
                                <textarea id="note" rows="3"></textarea>
                            </div>
                        `;
                    } else if (request.type === 'cvu') {
                        formHtml = `
                            <div class="form-group">
                                <label>CVU:</label>
                                <input type="text" id="cvu">
                            </div>
                            <div class="form-group">
                                <label>–ü–Ü–ë:</label>
                                <input type="text" id="fullName">
                            </div>
                            <div class="form-group">
                                <label>–°—É–º–∞ (ARS):</label>
                                <input type="number" id="amountLocal" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>–°—É–º–∞ (USDT):</label>
                                <input type="number" id="amountUSDT" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>–ü—Ä–∏–º—ñ—Ç–∫–∞:</label>
                                <textarea id="note" rows="3"></textarea>
                            </div>
                        `;
                    }

                    document.getElementById('orderDetailsForm').innerHTML = formHtml;
                    document.getElementById('addOrderDetailsModal').style.display = 'flex';
                });
        }

        async function submitOrderDetails() {
            const amountUSDT = parseFloat(document.getElementById('amountUSDT').value);

            if (!amountUSDT || amountUSDT <= 0) {
                alert('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É —Å—É–º—É –≤ USDT');
                return;
            }

            const orderData = {
                request_id: currentRequestId,
                amount_usdt: amountUSDT
            };

            // –î–æ–¥–∞—î–º–æ —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ –ø–æ–ª—è –≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—ñ–¥ —Ç–∏–ø—É
            const cardNumber = document.getElementById('cardNumber');
            const iban = document.getElementById('iban');
            const cvu = document.getElementById('cvu');

            if (cardNumber) {
                orderData.from_cabinet = currentCabinet;
                orderData.card_number = cardNumber.value;
                orderData.amount_local = parseFloat(document.getElementById('amountLocal').value);
                orderData.note = document.getElementById('note').value;
                orderData.type = 'card';
            } else if (iban) {
                orderData.from_cabinet = currentCabinet;
                orderData.iban = iban.value;
                orderData.tax_number = document.getElementById('taxNumber').value;
                orderData.full_name = document.getElementById('fullName').value;
                orderData.amount_local = parseFloat(document.getElementById('amountLocal').value);
                orderData.note = document.getElementById('note').value;
                orderData.type = 'iban';
            } else if (cvu) {
                orderData.from_cabinet = currentCabinet;
                orderData.cvu = cvu.value;
                orderData.full_name = document.getElementById('fullName').value;
                orderData.amount_local = parseFloat(document.getElementById('amountLocal').value);
                orderData.note = document.getElementById('note').value;
                orderData.type = 'cvu';
            }

            // –û—Ç—Ä–∏–º—É—î–º–æ —ñ–Ω—Ñ–æ –ø—Ä–æ –∑–∞–ø–∏—Ç –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è to_cabinet
            try {
                const requestsResponse = await fetch(`${API_URL}/order-requests`);
                const requests = await requestsResponse.json();
                const request = requests.find(r => r.id == currentRequestId);
                
                orderData.to_cabinet = request.from_cabinet;

                const response = await fetch(`${API_URL}/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });

                if (response.ok) {
                    closeModal('addOrderDetailsModal');
                    updateInterface();
                } else {
                    alert('–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –æ—Ä–¥–µ—Ä—É');
                }
            } catch (error) {
                console.error(error);
                
            }
        }

        // –û–ø–ª–∞—Ç–∞ –æ—Ä–¥–µ—Ä—É
        let isProcessing = false; // –§–ª–∞–≥ –¥–ª—è –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –º–Ω–æ–∂–∏–Ω–Ω–∏—Ö –∫–ª—ñ–∫—ñ–≤

        async function markAsPaid(orderId) {
            if (isProcessing) {
                return; // –Ø–∫—â–æ –≤–∂–µ –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è - —ñ–≥–Ω–æ—Ä—É—î–º–æ
            }

            isProcessing = true;

            try {
                const response = await fetch(`${API_URL}/orders/${orderId}/pay`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                if (response.ok) {
                    updateInterface();
                } else {
                    alert('–ü–æ–º–∏–ª–∫–∞ –æ–ø–ª–∞—Ç–∏');
                }
            } catch (error) {
                console.error(error);
                alert('–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è');
            } finally {
                isProcessing = false;
            }
        }

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–≤–∏—Ç–∞–Ω—Ü—ñ–π
        function openReceiptUpload(orderId) {
            currentOrderId = orderId;
            document.getElementById('uploadReceiptModal').style.display = 'flex';
        }

        function handleReceiptUpload() {
            const files = document.getElementById('receiptInput').files;
            receiptFiles = [];
            const preview = document.getElementById('receiptPreview');
            preview.innerHTML = '';

            for (let file of files) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    receiptFiles.push(e.target.result);
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'receipt-thumb';
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        }

        async function submitReceipt() {
            if (receiptFiles.length === 0) {
                alert('–û–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª–∏ –∫–≤–∏—Ç–∞–Ω—Ü—ñ—ó');
                return;
            }

            if (isProcessing) {
                return; // –Ø–∫—â–æ –≤–∂–µ –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è
            }

            isProcessing = true;

            // –ü–æ–∫–∞–∑—É—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
            const submitBtn = event.target;
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
            submitBtn.disabled = true;

            try {
                // –°–ø–æ—á–∞—Ç–∫—É –∫–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ base64 –≤ —Ñ–∞–π–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ
                const convertResponse = await fetch(`${API_URL}/convert-receipts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ receipts: receiptFiles })
                });

                const convertData = await convertResponse.json();
                
                if (!convertData.success) {
                    throw new Error('–ü–æ–º–∏–ª–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó –∑–æ–±—Ä–∞–∂–µ–Ω—å');
                }

                // –¢–µ–ø–µ—Ä –∑–±–µ—Ä—ñ–≥–∞—î–º–æ URL —Ñ–∞–π–ª—ñ–≤ –∑–∞–º—ñ—Å—Ç—å base64
                const response = await fetch(`${API_URL}/orders/${currentOrderId}/pay`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ receipts: convertData.fileUrls })
                });

                if (response.ok) {
                    closeModal('uploadReceiptModal');
                    updateInterface();
                } else {
                    alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–≤–∏—Ç–∞–Ω—Ü—ñ—ó');
                }
            } catch (error) {
                console.error(error);
                alert('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∫–≤–∏—Ç–∞–Ω—Ü—ñ—ó');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                isProcessing = false;
            }
        }

        // –ü–µ—Ä–µ–≥–ª—è–¥ –∫–≤–∏—Ç–∞–Ω—Ü—ñ–π
        async function viewReceipts(orderId) {
            try {
                const response = await fetch(`${API_URL}/orders/${currentCabinet}`);
                const orders = await response.json();
                const order = orders.find(o => o.id == orderId);

                if (!order) {
                    alert('–û—Ä–¥–µ—Ä –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
                    return;
                }

                const display = document.getElementById('receiptsDisplay');
                display.innerHTML = '';

                if (order.receipts) {
                    let receipts = order.receipts;
                    // –Ø–∫—â–æ receipts —Ü–µ —Å—Ç—Ä–æ–∫–∞, –ø–∞—Ä—Å–∏–º–æ JSON
                    if (typeof receipts === 'string') {
                        try {
                            receipts = JSON.parse(receipts);
                        } catch (e) {
                            console.error('–ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É –∫–≤–∏—Ç–∞–Ω—Ü—ñ–π:', e);
                            display.innerHTML = '<p>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–≤–∏—Ç–∞–Ω—Ü—ñ–π</p>';
                            return;
                        }
                    }
                    
                    if (Array.isArray(receipts) && receipts.length > 0) {
                        receipts.forEach(receipt => {
                            const img = document.createElement('img');
                            img.src = receipt;
                            img.style.maxWidth = '100%';
                            img.style.marginBottom = '10px';
                            img.style.borderRadius = '5px';
                            display.appendChild(img);
                        });
                    } else {
                        display.innerHTML = '<p>–ù–µ–º–∞—î –∫–≤–∏—Ç–∞–Ω—Ü—ñ–π</p>';
                    }
                } else {
                    display.innerHTML = '<p>–ù–µ–º–∞—î –∫–≤–∏—Ç–∞–Ω—Ü—ñ–π</p>';
                }

                document.getElementById('viewReceiptsModal').style.display = 'flex';
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≥–ª—è–¥—É –∫–≤–∏—Ç–∞–Ω—Ü—ñ–π:', error);
                alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–≤–∏—Ç–∞–Ω—Ü—ñ–π');
            }
        }

        // –°–∫–∞—Å—É–≤–∞–Ω–Ω—è –æ—Ä–¥–µ—Ä—É
        async function cancelOrder(orderId) {
            if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ —Å–∫–∞—Å—É–≤–∞—Ç–∏ —Ü–µ–π –æ—Ä–¥–µ—Ä?')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/orders/${orderId}/cancel`, {
                    method: 'PATCH'
                });

                if (response.ok) {
                    updateInterface();
                } else {
                    alert('–ü–æ–º–∏–ª–∫–∞ —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è');
                }
            } catch (error) {
                console.error(error);
                
            }
        }

        // –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –æ—Ä–¥–µ—Ä (–ª–æ–∫–∞–ª—å–Ω–æ)
        async function closeOrder(orderId) {
            try {
                const response = await fetch(`${API_URL}/orders/${orderId}/hide`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cabinet: currentCabinet })
                });

                if (response.ok) {
                    updateInterface();
                }
            } catch (error) {
                console.error(error);
            }
        }

        // TxID
        function openTxidInput(withdrawalId) {
            currentOrderId = withdrawalId;
            document.getElementById('txidModal').style.display = 'flex';
        }

        async function submitTxid() {
            const txid = document.getElementById('txidInput').value;

            if (!txid) {
                alert('–í–≤–µ–¥—ñ—Ç—å TxID');
                return;
            }

            if (isProcessing) {
                return; // –Ø–∫—â–æ –≤–∂–µ –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è
            }

            isProcessing = true;

            // –ü–æ–∫–∞–∑—É—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
            const submitBtn = event.target;
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '‚è≥ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è...';
            submitBtn.disabled = true;

            try {
                const response = await fetch(`${API_URL}/withdrawals/${currentOrderId}/confirm`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ txid: txid })
                });

                if (response.ok) {
                    closeModal('txidModal');
                    document.getElementById('txidInput').value = '';
                    updateInterface();
                } else {
                    alert('–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è');
                }
            } catch (error) {
                console.error(error);
                alert('–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                isProcessing = false;
            }
        }

        // –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≤–∏–≤—ñ–¥ (–ª–æ–∫–∞–ª—å–Ω–æ)
        async function closeWithdrawal(withdrawalId) {
            try {
                const response = await fetch(`${API_URL}/withdrawals/${withdrawalId}/hide`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cabinet: currentCabinet })
                });

                if (response.ok) {
                    updateInterface();
                }
            } catch (error) {
                console.error(error);
            }
        }

        // –í—ñ–¥–º—ñ–Ω–∞ –∑–∞–ø–∏—Ç—É –Ω–∞ –≤–∏–≤—ñ–¥
        async function cancelWithdrawal(withdrawalId) {
            if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤—ñ–¥–º—ñ–Ω–∏—Ç–∏ —Ü–µ–π –∑–∞–ø–∏—Ç –Ω–∞ –≤–∏–≤—ñ–¥?')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/withdrawals/${withdrawalId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    updateInterface();
                } else {
                    alert('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–º—ñ–Ω–∏ –≤–∏–≤–æ–¥—É');
                }
            } catch (error) {
                console.error(error);
            }
        }

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
        async function updateInterface() {
            try {
                await updateDebtInfo();
                await updateOrdersArea();
            } catch (error) {
                console.error(error);
            }
        }

        async function updateDebtInfo() {
            const response = await fetch(`${API_URL}/balances/${currentCabinet}`);
            const balances = await response.json();
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∑–º—ñ–Ω–∏ –±–∞–ª–∞–Ω—Å—É —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Ü–µ –Ω–µ –ø–µ—Ä—à–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
            const isFirstLoad = Object.keys(previousBalances).length === 0;
            
            if (!isFirstLoad) {
                checkBalanceChanges(balances);
            } else {
                console.log('First load - saving initial balances');
                previousBalances = { ...balances };
            }
            
            const debtInfo = document.getElementById('debtInfo');
            
            let html = '<h3>–ë–∞–ª–∞–Ω—Å–∏ –∑ –∫–∞–±—ñ–Ω–µ—Ç–∞–º–∏:</h3>';
            
            cabinets.forEach(cab => {
                if (cab !== currentCabinet) {
                    const balance = balances[cab] || 0;
                    const className = balance >= 0 ? 'debt-positive' : 'debt-negative';
                    const text = balance >= 0 ? `+${balance.toFixed(2)}` : balance.toFixed(2);
                    html += `
                        <div class="debt-item">
                            <span>${cab}</span>
                            <span class="${className}">${text} USDT</span>
                        </div>
                    `;
                }
            });

            debtInfo.innerHTML = html;
        }

        async function updateOrdersArea() {
            const [ordersRes, requestsRes, withdrawalsRes] = await Promise.all([
                fetch(`${API_URL}/orders/${currentCabinet}`),
                fetch(`${API_URL}/order-requests`),
                fetch(`${API_URL}/withdrawals/${currentCabinet}`)
            ]);

            const orders = await ordersRes.json();
            const requests = await requestsRes.json();
            const withdrawals = await withdrawalsRes.json();
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–æ–≤—ñ –¥–∞–Ω—ñ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Ü–µ –Ω–µ –ø–µ—Ä—à–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
            const isFirstLoad = previousOrders.length === 0 && previousRequests.length === 0 && previousWithdrawals.length === 0;
            
            if (!isFirstLoad) {
                checkNewOrders(orders);
                checkNewRequests(requests);
                checkNewWithdrawals(withdrawals);
            } else {
                console.log('First load - skipping notifications');
                // –ü–µ—Ä—à–∏–π —Ä–∞–∑ - –ø—Ä–æ—Å—Ç–æ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ
                previousOrders = [...orders];
                previousRequests = [...requests];
                previousWithdrawals = [...withdrawals];
            }

            const ordersArea = document.getElementById('ordersArea');
            ordersArea.innerHTML = '';

            const columns = {};

            // –í—Ö—ñ–¥–Ω—ñ –æ—Ä–¥–µ—Ä–∏
            const incomingOrders = orders.filter(o => o.to_cabinet === currentCabinet);
            incomingOrders.forEach(order => {
                if (!columns[order.from_cabinet]) {
                    columns[order.from_cabinet] = { incoming: [], outgoing: [], requests: [], outgoingRequests: [], withdrawals: [] };
                }
                columns[order.from_cabinet].incoming.push(order);
            });

            // –í–∏—Ö—ñ–¥–Ω—ñ –æ—Ä–¥–µ—Ä–∏
            const outgoingOrders = orders.filter(o => o.from_cabinet === currentCabinet);
            outgoingOrders.forEach(order => {
                if (!columns[order.to_cabinet]) {
                    columns[order.to_cabinet] = { incoming: [], outgoing: [], requests: [], outgoingRequests: [], withdrawals: [] };
                }
                columns[order.to_cabinet].outgoing.push(order);
            });

            // –ó–∞–ø–∏—Ç–∏ –Ω–∞ –æ—Ä–¥–µ—Ä–∏ —è–∫—ñ –º–∏ –≤—ñ–¥–ø—Ä–∞–≤–∏–ª–∏ —ñ–Ω—à–∏–º (—â–æ–± –∑–∞–ø–æ–≤–Ω–∏–ª–∏)
            const myRequests = requests.filter(r => r.to_cabinet === currentCabinet && r.remaining_amount > 0);
            myRequests.forEach(request => {
                if (!columns[request.from_cabinet]) {
                    columns[request.from_cabinet] = { incoming: [], outgoing: [], requests: [], outgoingRequests: [], withdrawals: [] };
                }
                columns[request.from_cabinet].requests.push(request);
            });

            // –ó–∞–ø–∏—Ç–∏ –Ω–∞ –æ—Ä–¥–µ—Ä–∏ —è–∫—ñ –º–∏ —Å—Ç–≤–æ—Ä–∏–ª–∏ (–Ω–∞—à—ñ –≤–∏—Ö—ñ–¥–Ω—ñ –∑–∞–ø–∏—Ç–∏)
            const outgoingRequests = requests.filter(r => r.from_cabinet === currentCabinet && r.remaining_amount > 0);
            outgoingRequests.forEach(request => {
                if (!columns[request.to_cabinet]) {
                    columns[request.to_cabinet] = { incoming: [], outgoing: [], requests: [], outgoingRequests: [], withdrawals: [] };
                }
                columns[request.to_cabinet].outgoingRequests.push(request);
            });

            // –í–∏–≤–æ–¥–∏
            const incomingWithdrawals = withdrawals.filter(w => w.to_cabinet === currentCabinet);
            const outgoingWithdrawals = withdrawals.filter(w => w.from_cabinet === currentCabinet);

            incomingWithdrawals.forEach(w => {
                if (!columns[w.from_cabinet]) {
                    columns[w.from_cabinet] = { incoming: [], outgoing: [], requests: [], outgoingRequests: [], withdrawals: [] };
                }
                columns[w.from_cabinet].withdrawals.push(w);
            });

            outgoingWithdrawals.forEach(w => {
                if (!columns[w.to_cabinet]) {
                    columns[w.to_cabinet] = { incoming: [], outgoing: [], requests: [], outgoingRequests: [], withdrawals: [] };
                }
                columns[w.to_cabinet].withdrawals.push(w);
            });

            // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ–ª–æ–Ω–æ–∫
            Object.keys(columns).forEach(cabinet => {
                const column = columns[cabinet];
                const columnDiv = document.createElement('div');
                columnDiv.className = 'order-column';

                let html = `<h3>${cabinet}</h3>`;

                // –ó–∞–ø–∏—Ç–∏ —è–∫—ñ –º–∏ –≤—ñ–¥–ø—Ä–∞–≤–∏–ª–∏ (–¥–ª—è –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —ñ–Ω—à–∏–º –∫–∞–±—ñ–Ω–µ—Ç–æ–º)
                column.requests.forEach(request => {
                    html += `
                        <div class="order-card request-card" onclick="openAddOrderDetails(${request.id})">
                            <div class="order-detail" style="font-size: 0.85em; color: #868e96;">üïê ${formatShortDateTime(request.created_at)}</div>
                            <div class="order-detail"><strong>üìã –ó–∞–ø–∏—Ç –Ω–∞ –æ—Ä–¥–µ—Ä–∏</strong></div>
                            <div class="order-detail">–ó–∞–ª–∏—à–∏–ª–æ—Å—å: <strong>${parseFloat(request.remaining_amount).toFixed(2)} USDT</strong></div>
                            <div class="order-detail">–¢–∏–ø: ${request.type === 'card' ? '–ö–∞—Ä—Ç–∫–∞' : request.type === 'iban' ? 'IBAN' : 'CVU'}</div>
                            <div class="order-detail" style="font-size: 0.85em; color: #868e96;">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –æ—Ä–¥–µ—Ä—É</div>
                        </div>
                    `;
                });

                // –ù–∞—à—ñ –≤–∏—Ö—ñ–¥–Ω—ñ –∑–∞–ø–∏—Ç–∏ (—è–∫—ñ –º–∏ —Å—Ç–≤–æ—Ä–∏–ª–∏) - –∑ –∫–Ω–æ–ø–∫–æ—é –≤—ñ–¥–º—ñ–Ω–∏
                column.outgoingRequests.forEach(request => {
                    html += `
                        <div class="order-card" style="background: #e3f2fd; border-left-color: #2196f3;">
                            <div class="order-detail" style="font-size: 0.85em; color: #868e96;">üïê ${formatShortDateTime(request.created_at)}</div>
                            <div class="order-detail"><strong>üì§ –ú—ñ–π –∑–∞–ø–∏—Ç –Ω–∞ –æ—Ä–¥–µ—Ä–∏</strong></div>
                            <div class="order-detail">–ó–∞–ø—Ä–æ—à–µ–Ω–æ: <strong>${parseFloat(request.amount).toFixed(2)} USDT</strong></div>
                            <div class="order-detail">–ó–∞–ª–∏—à–∏–ª–æ—Å—å: <strong>${parseFloat(request.remaining_amount).toFixed(2)} USDT</strong></div>
                            <div class="order-detail">–¢–∏–ø: ${request.type === 'card' ? '–ö–∞—Ä—Ç–∫–∞' : request.type === 'iban' ? 'IBAN' : 'CVU'}</div>
                            <div class="order-actions">
                                <button class="order-btn cancel" onclick="cancelOrderRequest(${request.id})" style="flex: 1;">‚úó –í—ñ–¥–º—ñ–Ω–∏—Ç–∏ –∑–∞–ø–∏—Ç</button>
                            </div>
                        </div>
                    `;
                });

                // –í—Ö—ñ–¥–Ω—ñ –æ—Ä–¥–µ—Ä–∏
                column.incoming.forEach(order => {
                    html += generateOrderCard(order, 'incoming');
                });

                // –í–∏—Ö—ñ–¥–Ω—ñ –æ—Ä–¥–µ—Ä–∏
                column.outgoing.forEach(order => {
                    html += generateOrderCard(order, 'outgoing');
                });

                // –í–∏–≤–æ–¥–∏
                column.withdrawals.forEach(withdrawal => {
                    html += generateWithdrawalCard(withdrawal);
                });

                columnDiv.innerHTML = html;
                ordersArea.appendChild(columnDiv);
            });
        }

        function generateOrderCard(order, direction) {
            let statusClass = order.status === 'pending' ? 'pending' : 
                            order.status === 'completed' ? 'completed' : 'cancelled';
            
            let html = `<div class="order-card ${statusClass}">`;
            html += `<div class="order-detail" style="font-size: 0.85em; color: #868e96;">üïê ${formatShortDateTime(order.created_at)}</div>`;

            if (order.type === 'card') {
                html += `
                    <div class="order-detail" style="display: flex; align-items: center; justify-content: space-between; flex-wrap: nowrap;">
                        <div style="flex: 1; min-width: 0;">
                            <strong>–ù–æ–º–µ—Ä –∫–∞—Ä—Ç–∫–∏:</strong> 
                            <span style="font-family: monospace; font-size: 1.05em;">${order.card_number}</span>
                        </div>
                        <button onclick="copyToClipboard('${order.card_number}', this)" 
                                style="flex-shrink: 0; margin-left: 10px; padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85em; white-space: nowrap;">
                            üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏
                        </button>
                    </div>
                    <div class="order-detail"><strong>–°—É–º–∞:</strong> ${order.amount_local} UAH</div>
                `;
            } else if (order.type === 'iban') {
                html += `
                    <div class="order-detail" style="display: flex; align-items: center; justify-content: space-between; flex-wrap: nowrap;">
                        <div style="flex: 1; min-width: 0;">
                            <strong>IBAN:</strong> 
                            <span style="font-family: monospace; font-size: 1.05em;">${order.iban}</span>
                        </div>
                        <button onclick="copyToClipboard('${order.iban}', this)" 
                                style="flex-shrink: 0; margin-left: 10px; padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85em; white-space: nowrap;">
                            üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏
                        </button>
                    </div>
                    <div class="order-detail"><strong>–ü–æ–¥–∞—Ç–∫–æ–≤–∏–π ‚Ññ:</strong> ${order.tax_number}</div>
                    <div class="order-detail"><strong>–ü–Ü–ë:</strong> ${order.full_name}</div>
                    <div class="order-detail"><strong>–°—É–º–∞:</strong> ${order.amount_local} UAH</div>
                `;
            } else if (order.type === 'cvu') {
                html += `
                    <div class="order-detail" style="display: flex; align-items: center; justify-content: space-between; flex-wrap: nowrap;">
                        <div style="flex: 1; min-width: 0;">
                            <strong>CVU:</strong> 
                            <span style="font-family: monospace; font-size: 1.05em;">${order.cvu}</span>
                        </div>
                        <button onclick="copyToClipboard('${order.cvu}', this)" 
                                style="flex-shrink: 0; margin-left: 10px; padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85em; white-space: nowrap;">
                            üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏
                        </button>
                    </div>
                    <div class="order-detail"><strong>–ü–Ü–ë:</strong> ${order.full_name}</div>
                    <div class="order-detail"><strong>–°—É–º–∞:</strong> ${order.amount_local} ARS</div>
                `;
            }

            html += `
                <div class="order-detail"><strong>USDT:</strong> ${parseFloat(order.amount_usdt).toFixed(2)}</div>
                <div class="order-detail"><strong>–ü—Ä–∏–º—ñ—Ç–∫–∞:</strong> ${order.note || '-'}</div>
            `;

            if (order.status === 'pending' && direction === 'incoming') {
                html += `
                    <div class="order-actions">
                        <button class="order-btn paid" onclick="markAsPaid(${order.id})">‚úì –°–ø–ª–∞—á–µ–Ω–æ</button>
                        <button class="order-btn receipt" onclick="openReceiptUpload(${order.id})">üìÑ –ó –∫–≤–∏—Ç–∞–Ω—Ü—ñ—î—é</button>
                        <button class="order-btn cancel" onclick="cancelOrder(${order.id})">‚úó –í—ñ–¥–º—ñ–Ω–∏—Ç–∏</button>
                    </div>
                `;
            } else if (order.status === 'completed') {
                html += `<div class="order-status status-completed">‚úì –°–ø–ª–∞—á–µ–Ω–æ</div>`;
                if (order.receipts) {
                    html += `<button class="order-btn receipt" style="margin-top: 10px;" onclick="viewReceipts(${order.id})">üìÑ –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –∫–≤–∏—Ç–∞–Ω—Ü—ñ—ó</button>`;
                }
                html += `
                    <div class="order-actions">
                        <button class="order-btn close" onclick="closeOrder(${order.id})">‚úó</button>
                    </div>
                `;
            } else if (order.status === 'cancelled') {
                html += `
                    <div class="order-status status-cancelled">‚úó –í—ñ–¥–º—ñ–Ω–µ–Ω–æ</div>
                    <div class="order-actions">
                        <button class="order-btn close" onclick="closeOrder(${order.id})">‚úó</button>
                    </div>
                `;
            }

            html += `</div>`;
            return html;
        }

        function generateWithdrawalCard(withdrawal) {
            const isIncoming = withdrawal.to_cabinet === currentCabinet;
            const isOutgoing = withdrawal.from_cabinet === currentCabinet;
            let statusClass = withdrawal.status === 'pending' ? 'pending' : 'completed';
            
            let html = `<div class="order-card ${statusClass}">`;
            html += `<div class="order-detail" style="font-size: 0.85em; color: #868e96;">üïê ${formatShortDateTime(withdrawal.created_at)}</div>`;
            html += `<div class="order-detail"><strong>üí∏ –ó–∞–ø–∏—Ç –Ω–∞ –≤–∏–≤—ñ–¥</strong></div>`;
            html += `<div class="order-detail"><strong>–°—É–º–∞:</strong> ${parseFloat(withdrawal.amount).toFixed(2)} USDT</div>`;
            html += `<div class="order-detail"><strong>–ê–¥—Ä–µ—Å–∞:</strong> ${withdrawal.address}</div>`;

            if (withdrawal.status === 'pending') {
                if (isIncoming) {
                    html += `
                        <div class="order-actions">
                            <button class="order-btn paid" onclick="openTxidInput(${withdrawal.id})">‚úì –°–ø–ª–∞—á–µ–Ω–æ</button>
                        </div>
                    `;
                } else if (isOutgoing) {
                    html += `
                        <div class="order-actions">
                            <button class="order-btn cancel" onclick="cancelWithdrawal(${withdrawal.id})">‚úó –í—ñ–¥–º—ñ–Ω–∏—Ç–∏</button>
                        </div>
                    `;
                }
            } else if (withdrawal.status === 'completed') {
                html += `<div class="order-status status-completed">‚úì –û–ø–ª–∞—á–µ–Ω–æ</div>`;
                html += `
                    <div class="order-detail" style="display: flex; align-items: center; justify-content: space-between; flex-wrap: nowrap;">
                        <div style="flex: 1; min-width: 0; overflow: hidden;">
                            <strong>TxID:</strong> 
                            <span style="font-family: monospace; font-size: 0.95em; word-break: break-all;">${withdrawal.txid}</span>
                        </div>
                        <button onclick="copyToClipboard('${withdrawal.txid}', this)" 
                                style="flex-shrink: 0; margin-left: 10px; padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85em; white-space: nowrap;">
                            üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏
                        </button>
                    </div>
                `;
                html += `
                    <div class="order-actions">
                        <button class="order-btn close" onclick="closeWithdrawal(${withdrawal.id})">‚úó</button>
                    </div>
                `;
            }

            html += `</div>`;
            return html;
        }
    </script>
</body>
</html>
